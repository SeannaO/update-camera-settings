<!DOCTYPE html>
<html>
    <head>
    	<meta http-equiv="X-UA-Compatible" content="IE=edge" /> 
        <link rel="stylesheet" href="/css/bootstrap.min.css">
        <link rel="stylesheet" href="/css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="/css/jquery-ui.css">

        <link rel="stylesheet" href="/css/cam.css">
        <link rel="stylesheet" href="/css/multi.css">

        <script src = "/js/jquery.min.js"></script>        
        <script src = "/js/jquery-ui.min.js"></script>
		<script src = "/js/player.js"></script>

        <script src="/js/timepicker.js"></script>
        <script src="/js/moment.min.js"></script>

		<script src = "/js/live.js"></script>

		<script type="text/javascript" src="/js/swfobject.js"></script>
        <script src="/js/socket.io-1.1.0.js"></script>

        <script src="/js/bootstrap.min.js"></script>
        <script src="/js/d3.v3.min.js"></script>
        <script src="/js/d3-timeline.js"></script>        

        <script>

			var sources = {};

            var playerHTML = function(id, rtsp, width, height) {
            }
			
			var rootUrl = location.protocol + '//' + location.host

			$(function(){
                var $list = $("#cameras-list");
                $.getJSON( "/cameras.json", function( data ) {
                    for (var i = 0; i < data.length; i++) {
                        if (data[i] && data[i].streams && data[i].streams.length > 0) {
							console.log('adding camera');
			
							cameras[data[i]._id] = data[i];
							console.log( cameras );
							var playerDiv = $('<div>', {
								id: 'video-container-' + i,
								class: 'video-container',
								style: 'position: relative; float: left;width:480px; height:320px; margin: 5px; margin-bottom: 25px;'
							}).appendTo($list);

							playerDiv.attr('data-camId', data[i]._id);

							var camName = $('<div>', {
								id:     'camera-menu-'+data[i]._id,
								class:  'camera-name',
								html:   data[i].name || data[i].ip
							}).appendTo(playerDiv);

							$('<div>', {
								id: 'toggle-overlay-'+ data[i]._id,
								class: 'toggle-overlay glyphicon glyphicon-align-justify'
							}).appendTo(playerDiv)
							.attr('data-camera-id', data[i]._id)
							.click( function() {
								toggleOverlay( $(this).attr('data-camera-id') );
							});

							var textOverlay = $('<div>', {
								class: 'camera-overlay',
								id: 'overlay-' + data[i]._id,
							}).appendTo(playerDiv);
							
							var posDrop = $('<div>', {
								class: 'pos-drop',
								id: 'pos-drop-'+data[i]._id
							}).appendTo(playerDiv);

							posDrop.attr('data-camId', data[i]._id);
							posDrop.droppable({
								activeClass: "ui-state-highlight",
								drop: function(e, ui) {
									var camId =  $(this).attr('data-camId');
									var posId =  ui.draggable.attr('data-pos-id');
									connectPOSToCamera( instances[posId], camId );
									saveState();
								}
							});

							var player = new Player( playerDiv );
							var camId = data[i]._id;
							var streamId = data[i].streams[0].id;
							var id = $(playerDiv).attr('id');

							sources[id] = {};
							sources[id].camId = camId;
							sources[id].streamId = streamId;

							$(playerDiv).on('playerInactive', function() {
								var id = $(this).attr('id');
								var camName = $(this).find('.camera-name');
								$(this).html(camName);
								var player = new Player( '#'+id );
								player.playVideo( 
									sources[id].camId, 
									sources[id].streamId
								);
							});
							
							if (data[i].status == 'offline') {
								playerDiv.append('<div style="width:100%;height:100%; background:rgb(200,200,200);padding: 10px;">camera offline</div>');
							} else {
								player.playVideo( camId, streamId );
							}
                        }
                    }
                });
            });
        </script>
    </head>


    <body style = "margin: 10px">
        <h2 class = 'text-muted'> <a href ="/cameras">cameras</a> | multiview </h2> 
        <hr>
        <div id="cameras-list" class = "video-items" style = "">
        </div>

		<div id = 'toggle-pos-list' style = 'display: none'> <span class ='glyphicon glyphicon-align-justify'></span></div>
		<div id = "pos-list" class = "pos-list"></div>
    </body>

	<script>
		var posMonitor = new POSMonitor( function(err, instancesArray) {
			if (err || !instancesArray) {
				console.log('could not connect to posmonitor');
				return;
			}

			$('#toggle-pos-list').fadeIn();

			for (var i in instancesArray) {
				var instance = instancesArray[i];
				instance.cameras = [];
				instances[ instance.id ] = instance;
				addPOSToList( instance );
			}

			// DEVELOPMENT ONLY
			// var socket = io.connect('https://solink:_tcpdump_wrapper_@192.168.0.13:3000');
			//

			// PRODUCTION
			var socket = io.connect('https://solink:_tcpdump_wrapper_@' + location.hostname + ':3000');
			//

			setTimeout( function() {
				loadState();
			}, 1000);

			socket.on('data', function(d) {
				if ( !instances[d.id] ) return;
				for (var i in instances[d.id].cameras) {
					var camera = instances[d.id].cameras[i];
					addTextToCamera( d.data, camera );
				}
			});
		});


		$('#toggle-pos-list').click(function() {
			togglePOSList();
		});

		

	</script>
</html>

